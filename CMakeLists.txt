cmake_minimum_required(VERSION 3.10)
project(Solver CXX)

# Set mpic++ as the C++ compiler.
set(CMAKE_CXX_COMPILER mpic++)

# Append necessary compile flags.
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -O3 -march=native -fopenmp -std=c++17")

# Define the source files.
set(SRCS
    src/main.cpp
    src/bnb.cpp
)

# Define separate variables for each directory.
set(BIN_DIR ${CMAKE_BINARY_DIR}/bin)
set(OUTPUT_DIR ${CMAKE_BINARY_DIR}/output)
set(LOG_DIR ${OUTPUT_DIR}/log)

# Create the directories.
file(MAKE_DIRECTORY ${BIN_DIR})
file(MAKE_DIRECTORY ${OUTPUT_DIR})
file(MAKE_DIRECTORY ${LOG_DIR})

# Add the executable target and specify its output directory.
add_executable(solver ${SRCS})
set_target_properties(solver PROPERTIES RUNTIME_OUTPUT_DIRECTORY ${BIN_DIR})

# (Optional) Add a custom target for cleaning up generated files.
add_custom_target(clean-all
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${BIN_DIR}
    COMMAND ${CMAKE_COMMAND} -E remove_directory ${OUTPUT_DIR}
    COMMAND ${CMAKE_COMMAND} -E echo "Cleaned up bin and output directories."
)

# Generation of the run_benchmarks.sh script in the build folder.
set(RUN_BENCHMARK_SCRIPT "${CMAKE_BINARY_DIR}/run_benchmarks.sh")

file(WRITE "${RUN_BENCHMARK_SCRIPT}" "#!/bin/bash\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# run_benchmarks.sh\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "#\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# This script runs the solver for each benchmark file (with extension .col)\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# located in the specified folders. For each input file the solver is executed with\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# MPI process counts: 1, 2, 4, 8, 16, 32, and 64.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "#\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# The solver must be compiled and be available in the ../build/bin folder as \"solver\".\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# The solver accepts three arguments: <input_file>, <time_limit_sec> and --log.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "#\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# The solver writes its results as a CSV file (<basename>.output) in ../build/output.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Define the MPI process counts to test.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "cpu_counts=(1 2 4 8 16 32 64)\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Define the folders containing benchmark input files.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "folders=(\"../instances\")\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Set the time limit for each run (in seconds).\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "TIME_LIMIT=500.0\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Define the directories for the executable and output files.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "BIN_DIR=\"../build/bin\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "OUTPUT_DIR=\"../build/output\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Ensure the output directory exists.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "mkdir -p \"$OUTPUT_DIR\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Name of the MPI+OpenMP executable (change if necessary)\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "EXECUTABLE=\"$BIN_DIR/solver\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# CSV output file for aggregated benchmark results.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "OUTPUT_CSV=\"$OUTPUT_DIR/benchmark_results.csv\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Write CSV header.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "echo \"Instance,Size,Edges,BestSolution,Optimum,TotalTime(s),Threads_Per_Node,CPUs_Per_Node,Nodes\" > \"$OUTPUT_CSV\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "# Loop over the folders and input files.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "for folder in \"\${folders[@]}\"; do\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "    # Check if folder exists.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "    if [[ ! -d \"\$folder\" ]]; then\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        echo \"Folder \$folder does not exist. Skipping...\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        continue\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "    fi\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "    # For each .col file in the folder.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "    for input_file in \"\$folder\"/*.col; do\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        # Skip if no .col files are found.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        if [[ ! -e \"\$input_file\" ]]; then\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            echo \"No .col files found in \$folder.\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            break\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        fi\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        base=\$(basename \"\$input_file\")\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        echo \"Processing benchmark: \$input_file\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        # For each requested MPI process count.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        for np in \"\${cpu_counts[@]}\"; do\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            echo \"  Running with \$np MPI processes...\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            # Remove any previous output file.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            output_file=\"$OUTPUT_DIR/\${base%.*}.output\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            if [[ -f \"\$output_file\" ]]; then\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                rm \"\$output_file\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            fi\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            # Run the executable using mpirun with --log enabled by default.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            mpirun -np \"\$np\" \"\$EXECUTABLE\" \"\$input_file\" \"\$TIME_LIMIT\" --log\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            # Wait for the output file to be written.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            sleep 1\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            # Check if the expected output file was created and parse it if available.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            if [[ -f \"\$output_file\" ]]; then\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                # Read the CSV output file generated by the solver. Skip the header line by taking the last line.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                data=\$(tail -n 1 \"\$output_file\")\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                IFS=',' read -r instance size edges bestSolution optimum totalTime threadsPerNode cpusPerNode nodes <<< \"\$data\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            else\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                instance=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                size=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                edges=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                bestSolution=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                optimum=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                totalTime=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                threadsPerNode=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                cpusPerNode=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "                nodes=\"N/A\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            fi\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            # Append a new row to the aggregated CSV file with the complete data from the .output file.\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "            echo \"\$instance,\$size,\$edges,\$bestSolution,\$optimum,\$totalTime,\$threadsPerNode,\$cpusPerNode,\$nodes\" >> \"$OUTPUT_CSV\"\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "        done\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "    done\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "done\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "\n")
file(APPEND "${RUN_BENCHMARK_SCRIPT}" "echo \"Benchmarking complete. Results saved in \$OUTPUT_CSV.\"\n")

# Make the script executable.
file(CHMOD "${RUN_BENCHMARK_SCRIPT}" PERMISSIONS OWNER_READ OWNER_WRITE OWNER_EXECUTE GROUP_READ GROUP_EXECUTE WORLD_READ WORLD_EXECUTE)
